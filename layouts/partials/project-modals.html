{{ "<!-- Portfolio Modals -->" | safeHTML }}
{{ $lang := .Site.Language.Lang }}
{{ range $projectIndex, $project := .Site.Data.projects }}
<div class="iconem-modal modal fade" id="portfolioModal{{ $project.modalID }}" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-content col-sm-10 col-sm-offset-1 col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3">
        
        <img src="../img/home/cross.png" class="close-modal" data-dismiss="modal"
            onclick="stopPreviewCarousel({{ $projectIndex }})">
        
        <div class="col-sm-10 col-sm-offset-1 modal-body">
            <div class="modal-fixed">
                <h3 class="text-uppercase">{{ index $project.title $lang }}</h3>
                <div>
                    <hr/>
                </div>
                <div class="project-media-icons-container">
                    {{ if (or $project.video $project.models) }}
                        <a role="button" 
                            data-toggle="collapse"
                            href="#project-{{ $projectIndex }}-img-carousel"
                            data-parent='#project-{{$projectIndex}}-media'
                            aria-expanded="true">
                            <img src="../img/projects/icons/img_black.png">
                        </a>
                        {{ if $project.video }}
                            <a role="button" 
                                data-toggle="collapse"
                                class="collapsed"
                                href="#project-{{ $projectIndex }}-video-carousel"
                                data-parent='#project-{{$projectIndex}}-media'
                                aria-expanded="false"
                                onclick="stopPreviewCarousel({{ $projectIndex }})">
                                <img src="../img/projects/icons/video_black.png">
                            </a>
                        {{ end }}
                        {{ if $project.models }}
                            <a role="button" 
                                data-toggle="collapse"
                                class="collapsed"
                                href="#project-{{ $projectIndex }}-models-carousel"
                                data-parent='#project-{{$projectIndex}}-media'
                                aria-expanded="false"
                                onclick="stopPreviewCarousel({{ $projectIndex }})">
                                <img src="../img/projects/icons/3ds_black.png">
                            </a>
                        {{ end }}
                    {{ end }}
                </div>

                <div class="project-media-container">
                    {{ with (index $project.img 0) }}
                        <img class="img-responsive dummy" src="{{ .preview }}">
                    {{ end }}
                    <div class="panel-group project-media" id="project-{{$projectIndex}}-media" role="tablist" aria-multiselectable="false">

                        {{ "<!-- Image carousel -->" | safeHTML }}
                        <div class="panel">
                            <div id="project-{{ $projectIndex }}-img-carousel" class="panel-collapse collapse in" role="tabpanel">
                                <div class="project-media-type text-uppercase">
                                    {{ $.Site.Params.projects.modal.pictures }}
                                </div>
                                <div class="owl-carousel owl-theme preview-img-carousel">
                                    {{ range $imgIndex, $img := $project.img }}
                                        <div>
                                            <img src="{{ $img.full }}" class="img-responsive">
                                            <div class="img-caption">
                                                {{ index $img.caption $lang }}
                                                <div class="img-fullscreen-btn"
                                                onclick="toggleFullScreenCarousel('#project-{{ $projectIndex }}-img-carousel')"
                                                >
                                                    <img src="../img/projects/icons/fullScreen_white.png">
                                                </div>
                                            </div>
                                        </div>
                                    {{ end }}
                                </div>
                                <div class="img-cross" onclick="toggleFullScreenCarousel('#project-{{ $projectIndex }}-img-carousel')">
                                    COUCOU
                                </div>
                            </div>
                        </div>

                        {{ "<!-- Video carousel -->" | safeHTML }}
                        {{ if $project.video }}
                        <div class="panel">
                            <div id="project-{{ $projectIndex }}-video-carousel" class="panel-collapse collapse" role="tabpanel">
                                <div class="project-media-type text-uppercase">
                                    {{ $.Site.Params.projects.modal.videos }}
                                </div>
                                <div class="owl-carousel owl-theme video-carousel">
                                    {{ range $project.video }}
                                        <a class="owl-video" href="{{ . }}"></a>
                                    {{ end }}
                                </div>
                            </div>
                        </div>
                        {{ end }}

                        {{ "<!-- 3D models carousel -->" | safeHTML }}
                        {{ if $project.models }}
                        <div class="panel">
                            <div id="project-{{ $projectIndex }}-models-carousel" class="panel-collapse collapse" role="tabpanel">
                                <div class="project-media-type text-uppercase">
                                    {{ $.Site.Params.projects.modal.models }}
                                </div>
                                <div class="owl-carousel owl-theme 3d-carousel">
                                    {{ range $project.models }}
                                        <iframe width="100%" height="100%" 
                                        src="{{ . }}" frameborder="0" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" onmousewheel="">
                                        </iframe>
                                    {{ end }}
                                </div>
                            </div>
                        </div>
                        {{ end }}
                    </div>
                </div>
            </div>
            <div class="modal-scrollable text-justify">
                <strong>2017</strong>
                <i>Exposition au Grand Palais</i>
                <div>
                    <strong>{{ $.Site.Params.projects.modal.actors }}</strong>
                    <span>{{ index $project.actors $lang }}</span>
                </div>
                <div>
                    <strong>{{ $.Site.Params.projects.modal.partners }}</strong>
                    <span>{{ index $project.partners $lang }}</span>
                </div>
                <hr align="left">
                <div>{{ index $project.description $lang | markdownify }}</div>
            </div>
        </div>
    </div>
</div>
{{ end }}


<script type="text/javascript">
    function stopPreviewCarousel(projectIndex) {
        var id = `#project-${projectIndex }-img-carousel`;
        $(id).find('.owl-carousel.preview-img-carousel').trigger('stop.owl.autoplay');
    }

    function resizeFull(carouselId) {
        $(carouselId).find('.owl-carousel')
        .css('width', window.innerWidth)
        .css('height', window.innerHeight);

        $(carouselId).find('.owl-carousel .owl-item')
        .css('width', window.innerWidth)
        .css('height', window.innerHeight);

        $(carouselId).find('.owl-carousel').trigger('refresh.owl.carousel');
    }

    function toggleFullScreenCarousel(carouselId) {
        $(carouselId).find('.owl-carousel').trigger('stop.owl.autoplay');

        if ($(carouselId).find('.owl-carousel').hasClass('full')) {
            window.removeEventListener('resize', resizeHandler, true);
            window.removeEventListener('keyup', keyupHandler, true);

            $(carouselId).find('.owl-carousel')
            .removeClass('full')
            .css('width', 'initial')
            .css('height', 'initial')

            $(carouselId).find('.owl-carousel .owl-item')
            .css('width', 'initial')
            .css('height', 'initial');

            $(carouselId).find('.owl-carousel .owl-item > div')
            .css('position', 'initial')
            .css('height', 'initial');

            $(carouselId).find('.owl-carousel .owl-item div img')
            .css('position', 'initial')
            .css('top', 'initial')
            .css('left', 'initial')
            .css('transform', 'initial');

            // $(carouselId).find('.owl-carousel i')
            // .removeClass('fa-compress')
            // .addClass('fa-expand');

            $(carouselId).find('.owl-carousel').trigger('refresh.owl.carousel');
        } else {
            $(carouselId).find('.owl-carousel')
            .addClass('full');

            $(carouselId).find('.owl-carousel .owl-item > div')
            .css('position', 'relative')
            .css('height', '100%');

            $(carouselId).find('.owl-carousel .owl-item > div > img')
            .css('position', 'absolute')
            .css('top', '50%')
            .css('left', '50%')
            .css('transform', 'translateY(-50%) translateX(-50%)');

            // $(carouselId).find('.owl-carousel i')
            // .removeClass('fa-expand')
            // .addClass('fa-compress');

            resizeFull(carouselId);

            window.addEventListener('resize', resizeHandler=function(){ resizeFull(carouselId); }, true);
            window.addEventListener('keyup', keyupHandler=function (e) {
                if (e.keyCode === 27 && $(carouselId).find('.owl-carousel').hasClass('full')) {
                    toggleFullScreenCarousel(carouselId);
                }
            }, true);
        }
    }
</script>